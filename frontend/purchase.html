<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Purchase</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">
  <div class="max-w-4xl mx-auto">
    <h2 class="text-3xl font-bold mb-6 text-gray-800">Create Purchase</h2>

    <!-- Supplier & Item Selection -->
     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block mb-1 font-semibold">Supplier</label>
          <select
            id="supplierSelect"
            class="w-full rounded border-gray-300 px-3 py-2 shadow-sm"
          ></select>
        </div>

        <div>
          <label class="block mb-1 font-semibold">Item</label>
          <select
            id="itemSelect"
            class="w-full rounded border-gray-300 px-3 py-2 shadow-sm"
          ></select>
        </div>

        <div>
          <label class="block mb-1 font-semibold">Qty</label>
          <input
            type="number"
            id="qty"
            min="1"
            placeholder="Qty"
            class="w-full rounded border-gray-300 px-3 py-2 shadow-sm"
          />
        </div>

        <div class="flex items-end">
          <button
            id="addItem"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition w-full"
          >
            Tambah
          </button>
        </div>
      </div>

    <!-- Cart Table -->
    <div class="overflow-x-auto bg-white shadow rounded-lg mb-4">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
          </tr>
        </thead>
        <tbody id="cartTable" class="bg-white divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <button id="submitOrder" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">Submit Order</button>
  </div>

  <script src="js/api.js"></script>
  <script>
    let cart = [];
    let itemsMap = {}; // id -> {Name, Stock}

    // LOAD SUPPLIER & ITEMS
    $(document).ready(function() {
      apiRequest("GET", "/suppliers").done(data => {
        data.forEach(s => {
          $("#supplierSelect").append(`<option value="${s.ID}">${s.Name}</option>`);
        });
      });

      apiRequest("GET", "/items").done(data => {
        data.forEach(i => {
          $("#itemSelect").append(`<option value="${i.ID}">${i.Name}</option>`);
          itemsMap[i.ID] = { Name: i.Name, Stock: i.Stock }; // save for display & validation
        });
      });
    });

    // ADD ITEM
    $("#addItem").click(function() {
      const itemId = parseInt($("#itemSelect").val());
      const qty = parseInt($("#qty").val());
      const selectedItem = itemsMap[itemId];

      if (!qty || qty <= 0) {
        Swal.fire("Error", "Qty tidak valid", "error");
        return;
      }

      // Cek stock
      const existing = cart.find(c => c.item_id === itemId);
      if (existing) {
        if (existing.qty + qty > selectedItem.Stock) {
          Swal.fire("Error", "Total Qty melebihi stock tersedia", "error");
          return;
        }
        existing.qty += qty;
      } else {
        if (qty > selectedItem.Stock) {
          Swal.fire("Error", "Qty melebihi stock tersedia", "error");
          return;
        }
        cart.push({ item_id: itemId, qty });
      }

      renderCart();
    });

    // RENDER CART
    function renderCart() {
      $("#cartTable").html("");
      if (cart.length === 0) {
        $("#cartTable").append(`
          <tr><td colspan="3" class="text-center py-4 text-gray-500">Cart kosong</td></tr>
        `);
        return;
      }

      cart.forEach((c, index) => {
        $("#cartTable").append(`
          <tr class="hover:bg-gray-50 transition">
            <td class="px-6 py-4 whitespace-nowrap">${itemsMap[c.item_id].Name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${c.qty}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <button class="remove bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 transition" data-index="${index}">Hapus</button>
            </td>
          </tr>
        `);
      });
    }

    // REMOVE ITEM
    $(document).on("click", ".remove", function() {
      cart.splice($(this).data("index"), 1);
      renderCart();
    });

    // SUBMIT ORDER
    $("#submitOrder").click(function() {
      if (cart.length === 0) {
        Swal.fire("Error", "Cart masih kosong", "error");
        return;
      }

      apiRequest("POST", "/purchases", {
        supplier_id: parseInt($("#supplierSelect").val()),
        items: cart.map(c => ({ ItemID: c.item_id, Qty: c.qty }))
      })
      .done(() => {
        Swal.fire("Success", "Order berhasil", "success");
        cart = [];
        renderCart();
      })
      .fail(res => {
        Swal.fire("Error", res.responseJSON?.error || "Gagal", "error");
      });
    });
  </script>
</body>
</html>
